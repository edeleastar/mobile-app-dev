 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> Lab-10 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
     <link rel="stylesheet" href="./style/semantic/css/semantic.min.css" type="text/css">  
     <link rel="stylesheet" href="./style/custom/main.css" type="text/css"> 
   
     <script src="./style/custom/jquery-2.1.0.min.js"></script> 
     <script src="./style/custom/jquery.address-1.6.min.js"></script>
     <script src="./style/semantic/javascript/semantic.min.js"></script>
   
     <link rel="stylesheet" href="./style/highlight/school_book.css">
     <script src="./style/highlight/highlight.pack.js"></script> 
     <script>hljs.initHighlightingOnLoad();</script>
   
     <script src="./style/custom/common.js"> </script> 
     <script src="./style/custom/main.js"> </script> 
  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">Enhanced Donation Service/App</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="Lab-10"> Lab-10 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="">  </a>
          <a class="item" data-tab="Exercises"> Exercises </a>
    </div>
  </nav>

  <br>

	  <section data-tab="Lab-10" class="ui tab stacked moodle-book segment">
	     <h1>Objectives</h1>
<ul>
<li>Deploy the donation-service app to cloudbees</li>
<li>Implement donation-android/donation-service interaction for registration and donation activities </li>
<li>Explore Eclipse Refactoring in more depth</li>
</ul>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Exercise Solutions</h1>
<p>These are the completed labs from last week:</p>
<ul>
<li><a href="archives/donation-service.zip">donation-service.zip</a></li>
<li><a href="archives/donation-android.zip">donation-android.zip</a></li>
</ul>
<h2>Exercise 1: Cloudbees</h2>
<p>Publish the donation-service app to Cloudbees - and have the android app user that service instead of the locally hosted version.</p>
<p>You may have forgotten the steps for cloudbees deployment - but it involves:</p>
<ul>
<li>Creating an Application on Cloudbees</li>
<li>Creating a Database on Cloudbees</li>
</ul>
<p>.. and then make the following changes in the play project:</p>
<h3>app/dependenies.yaml</h3>
<h1>Application dependencies</h1>
<p>In dos/terminal, enter:</p>
<pre><code> play install cloudbees
</code></pre>

<p>Edit app/dependenies.yaml and make following change:</p>
<pre><code>require:
    - play
    - play -&gt; cloudbees 0.2.2
</code></pre>

<p>Change into the donation-service folder and enter:</p>
<pre><code>play deps
</code></pre>

<h3>app/application.conf</h3>
<p>Comment out the in memory setup for the database:</p>
<pre><code>#db=mem
</code></pre>

<p>.. and then bring in the setting for cloudbees:</p>
<pre><code>db.url=jdbc:cloudbees://YOUR_DB_NAME
db.driver=com.mysql.jdbc.Driver 
db.user=YOUR_DB_USER_NAME
db.pass=YOUR_DB_USER_PASSWORD

jpa.ddl=create
</code></pre>

<p>and in the same file, you cloudbees keys:</p>
<pre><code>bees.api.key=YOUT_KEY
bees.api.secret=YOUR_SECRET
bees.api.domain=YOUR_DOMAIN
bees.api.name=YOUR_APP_NAME
</code></pre>

<p>The command to deploy the app is </p>
<pre><code>play bees:app:deploy
</code></pre>

<p>The Rest class has local ip address hardcoded:</p>
<pre><code>public class Rest
{
  private static DefaultHttpClient httpClient = null;
  //private static final String URL = &quot;http://10.0.2.2:9000&quot;;
  private static final String URL = &quot;http://donation-edel020.edel020.cloudbees.net&quot;;
</code></pre>

<p>So replace it with your own cloudbees url (not the one above!)</p>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Exercise 2: When users sign up, their details are send to the donation-service play app</h1>
<p>The application as it currently stands uses two aspects of the donation play application:</p>
<ul>
<li>Let users log in who are already 'registered' online</li>
<li>Display a list of donations downloaded form the web service</li>
</ul>
<p>See if you can figure out how to:</p>
<ul>
<li>when users sign up, their details are send to the donation-service play app</li>
<li>when a donation is made, it is sent to the donation-service play app</li>
</ul>
<p>The facilities are already in the play app for this, so you will only be making changes to the android application.</p>
<h1>Solution</h1>
<h2>When users sign up, their details are send to the donation-service play app</h2>
<p>Before working up to a solution to this, we might first introduce a new  attribute in the DonationApp class:</p>
<pre><code class="java">  public boolean         donationServiceAvailable = false;
</code></pre>

<p>Every time we connect, we will set the last know status of our connection to the service here:/</p>
<p>Currently, the app loads the users from the service in the Login activity. This might not bee such a good idea. Lets move it to the welcome screen, so we will have preloaded the user list before starting the login activity:</p>
<pre><code class="java">package app.activities;

import java.util.List;
import app.donation.R;
import app.http.Response;
import app.main.DonationApp;
import app.models.DonationServiceAPI;
import app.models.User;
import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.Toast;

public class Welcome extends Activity implements Response&lt;User&gt;
{
  DonationApp app;

  @Override
  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_welcome);
    app = (DonationApp) getApplication();

    DonationServiceAPI.getUsers(this, this, &quot;Retrieving list of users&quot;);
  }

  void serviceUnavailableMessage()
  {
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
  }

  public void loginPressed (View view) 
  {
    if (app.donationServiceAvailable)
    {
      startActivity (new Intent(this, Login.class));
    }
    else
    {
      serviceUnavailableMessage();
    }
  }

  public void signupPressed (View view) 
  {
    if (app.donationServiceAvailable)
    {
      startActivity (new Intent(this, Signup.class));
    }
    else
    {
      serviceUnavailableMessage();
    }
  }

  @Override
  public void setReponse(List&lt;User&gt; aList)
  {
    app.users = aList;
    app.donationServiceAvailable = true;
  }

  @Override
  public void errorOccurred(Exception e)
  {
    app.donationServiceAvailable = false;
    serviceUnavailableMessage();
  }

  @Override
  public void setReponse(User anObject)
  {}
}

</code></pre>

<p>Read the above class carefully - and note how we make use of the `donationServiceAvailable' flag in DonationApp.</p>
<p>Login can now be simplified to its original form:</p>
<pre><code class="java">package app.activities;

import android.os.Bundle;
import android.app.Activity;
import android.content.Intent;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;
import app.donation.R;
import app.main.DonationApp;

public class Login extends Activity
{
  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_login);
  }

  public void signinPressed (View view) 
  {
    DonationApp app = (DonationApp) getApplication();

    TextView email     = (TextView)  findViewById(R.id.loginEmail);
    TextView password  = (TextView)  findViewById(R.id.loginPassword);

    if (app.validUser(email.getText().toString(), password.getText().toString()))
    {
      startActivity (new Intent(this, Donate.class));
    }
    else
    {
      Toast toast = Toast.makeText(this, &quot;Invalid Credentials&quot;, Toast.LENGTH_SHORT);
      toast.show();
    }
  }
}
</code></pre>

<p>We will only be reaching this activity if we have successfully connected to the service.</p>
<p>This is a revised version of Signup, which makes use of the service:</p>
<pre><code class="java">package app.activities;

import java.util.List;
import android.os.Bundle;
import android.app.Activity;
import android.content.Intent;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;
import app.donation.R;
import app.http.Response;
import app.main.DonationApp;
import app.models.DonationServiceAPI;
import app.models.User;

public class Signup extends Activity implements Response&lt;User&gt;
{
  private DonationApp app;

  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_signup);
    app = (DonationApp) getApplication();
  }

  public void registerPressed (View view) 
  {
    TextView firstName = (TextView)  findViewById(R.id.firstName);
    TextView lastName  = (TextView)  findViewById(R.id.lastName);
    TextView email     = (TextView)  findViewById(R.id.Email);
    TextView password  = (TextView)  findViewById(R.id.Password);

    User user = new User (firstName.getText().toString(), lastName.getText().toString(), email.getText().toString(), password.getText().toString());

    DonationServiceAPI.createUser(this, this, &quot;Registering new user&quot;, user);
  }

  @Override
  public void setReponse(List&lt;User&gt; aList)
  {
  }

  @Override
  public void setReponse(User user)
  { 
    app.users.add(user);
  }

  @Override
  public void errorOccurred(Exception e)
  {
    app.donationServiceAvailable = false;
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
    startActivity (new Intent(this, Welcome.class));
  }
}
</code></pre>

<p>This should work now.</p>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>Exercise 2: When a donation is made, it is sent to the donation-service play app</h1>
<p>This takes a bit more work, and involved refactoring the donate button handler to only make the donation in the callback method:</p>
<pre><code class="java">package app.activities;

import java.util.List;
import app.donation.R;
import app.http.Response;
import app.main.DonationApp;
import app.models.Donation;
import app.models.DonationServiceAPI;
import android.os.Bundle;
import android.app.Activity;
import android.content.Intent;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.RadioGroup;
import android.widget.NumberPicker;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

public class Donate extends Activity implements Response&lt;Donation&gt;
{
  private RadioGroup   paymentMethod;
  private ProgressBar  progressBar;
  private NumberPicker amountPicker;
  private TextView     amountText;
  private TextView     amountTotal;
  private DonationApp  app;

  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_donate);

    app = (DonationApp) getApplication();

    paymentMethod = (RadioGroup)   findViewById(R.id.paymentMethod);
    progressBar   = (ProgressBar)  findViewById(R.id.progressBar);
    amountPicker  = (NumberPicker) findViewById(R.id.amountPicker);
    amountText    = (TextView)     findViewById(R.id.amountText);
    amountTotal   = (TextView)     findViewById(R.id.amountTotal);

    amountPicker.setMinValue(0);
    amountPicker.setMaxValue(1000);
    progressBar.setMax(app.target);
  }

  @Override
  public boolean onCreateOptionsMenu(Menu menu)
  {
    getMenuInflater().inflate(R.menu.donate, menu);
    return true;
  }

  @Override
  public boolean onOptionsItemSelected(MenuItem item)
  {
    switch (item.getItemId())
    {
      case R.id.menuReport : startActivity (new Intent(this, Report.class));
                             break;
      case R.id.menuLogout : startActivity (new Intent(this, Welcome.class));
                             break;                             
    }
    return true;
  }

  public void donateButtonPressed (View view) 
  {
    String method = paymentMethod.getCheckedRadioButtonId() == R.id.PayPal ? &quot;PayPal&quot; : &quot;Direct&quot;;
    int donatedAmount =  amountPicker.getValue();
    if (donatedAmount == 0)
    {
      String text = amountText.getText().toString();
      if (!text.equals(&quot;&quot;))
        donatedAmount = Integer.parseInt(text);
    }
    if (donatedAmount &gt; 0)
    {
      DonationServiceAPI.createDonation(this, this, &quot;Registering new donation...&quot;, new Donation(donatedAmount, method));
    }
   }

  @Override
  public void setReponse(Donation acceptedDonation)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Accepteed&quot;, Toast.LENGTH_SHORT);
    toast.show();
    app.newDonation(acceptedDonation);
    progressBar.setProgress(app.totalDonated);
    String totalDonatedStr = &quot;$&quot; + app.totalDonated;
    amountTotal.setText(totalDonatedStr);
    amountText.setText(&quot;&quot;);
    amountPicker.setValue(0);
  }

  @Override
  public void errorOccurred(Exception e)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
  }

  @Override
  public void setReponse(List&lt;Donation&gt; aList)
  {}
}
</code></pre>
	  </section>
	  <section data-tab="" class="ui tab stacked moodle-book segment">
	     <h1>Refactor / Rename</h1>
<p>The donation-android app has an unfortunate type in the name of the Response interface methods:</p>
<pre><code class="java">public interface Response&lt;T&gt;
{
  public void setReponse(List&lt;T&gt; aList);
  public void setReponse(T anObject);
  public void errorOccurred (Exception e);
}
</code></pre>

<p>Missing an 's' on setReponse!</p>
<p>Changing this will cause errors throughout our activities - however, there is a way to change this and have all the activities changed automatically. This is to use the Eclipse 'refactorring' menu options.</p>
<p>This needs to be accessed via eclipse package explorer view:</p>
<p><img alt="" src="img/01.png">
<img alt="" src="img/02.png"></p>
<p>Do this for both methods. If you get warning - press "continue" anyway.</p>
<p>If all goes according to plan, it should successfully rename all relevant artifacts.</p>
	  </section>
	  <section data-tab="Exercises" class="ui tab stacked moodle-book segment">
	     <h1>Exercises</h1>
<p>Archive of the lab so far:</p>
<ul>
<li><a href="archives/donation-android-v4.zip">donation-android-v4.zip</a></li>
</ul>
<h2>Exercise 1</h2>
<p>Does it make sense to download the full list of users when we load the Welcome activity? Perhaps it might be better if we just attempted to reach donation-service, and indicate to the user if it is available or not.</p>
<p>Consider how you might do this.</p>
<h2>Exercise 2</h2>
<p>When Login is launched, it might be better to just check that the user supplied credentials are valid - with the donation-service app, and not by inspecting our local list of users.</p>
<p>How would this be done?</p>
<h2>Exercise 3</h2>
<p>In the Singup activity - we should really check to see if the new user email is not already taken.</p>
<p>How would we do this?</p>
	  </section>
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@wit.ie). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-49703418-7']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>  </body>
 </html>